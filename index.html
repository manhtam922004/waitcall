<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaitCall - Trò chuyện ngẫu nhiên</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Giữ nguyên toàn bộ CSS từ bản trước */
    </style>
</head>
<body>
    <div class="container">
        <!-- Giữ nguyên cấu trúc HTML từ bản trước -->
    </div>

    <script>
        // ==================== CẤU HÌNH NÂNG CAO ====================
        const firebaseConfig = {
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.appspot.com",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== BIẾN VÀ HẰNG SỐ ====================
        let userId = generateUserId();
        let currentMode = 'video';
        let isWaiting = false;
        let isConnected = false;
        let autoReconnect = false;
        let peerConnection = null;
        let dataChannel = null;
        let currentRoomId = null;
        let localStream = null;
        let waitingRef = null;

        const rtcConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" },
                { 
                    urls: "turn:your-turn-server.com",
                    username: "username",
                    credential: "password"
                }
            ]
        };

        // ==================== CORE FUNCTIONS ====================
        async function initMediaStream(mode) {
            try {
                const constraints = {
                    audio: true,
                    video: mode === 'video' ? {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    } : false
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('local-video').srcObject = localStream;
                return localStream;
            } catch (error) {
                console.error("Lỗi truy cập thiết bị:", error);
                alert("Vui lòng cho phép truy cập camera/microphone!");
                handleDisconnect();
                return null;
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);

            // Thêm track local
            localStream?.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Xử lý ICE Candidate
            peerConnection.onicecandidate = ({ candidate }) => {
                if (candidate && currentRoomId) {
                    database.ref(`rooms/${currentRoomId}/candidates/${userId}`).push(candidate.toJSON());
                }
            };

            // Xử lý remote track
            peerConnection.ontrack = (event) => {
                const remoteVideo = document.getElementById('remote-video');
                if (event.track.kind === 'video') {
                    remoteVideo.srcObject = event.streams[0];
                }
                setupDataChannel();
            };
        }

        // ==================== IMPROVED CONNECTION LOGIC ====================
        async function startWaiting() {
            if (isWaiting || isConnected) return;

            try {
                isWaiting = true;
                updateStatusUI('waiting');
                
                if (currentMode !== 'chat') {
                    await initMediaStream(currentMode);
                }

                createPeerConnection();
                setupDataChannel();

                waitingRef = database.ref('waiting');
                const snapshot = await waitingRef.orderByChild('mode').equalTo(currentMode).once('value');
                const waitingUsers = snapshot.val() || {};

                if (Object.keys(waitingUsers).length > 0) {
                    const partnerId = Object.keys(waitingUsers)[0];
                    currentRoomId = `${partnerId}_${userId}`;
                    await createOffer(partnerId);
                    await waitingRef.child(partnerId).remove();
                } else {
                    await waitingRef.child(userId).set({
                        mode: currentMode,
                        timestamp: Date.now()
                    });
                    listenForPartner();
                }

            } catch (error) {
                console.error("Lỗi bắt đầu kết nối:", error);
                handleDisconnect();
            }
        }

        async function createOffer(partnerId) {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await database.ref(`rooms/${currentRoomId}`).set({
                offer: offer,
                from: userId,
                to: partnerId,
                mode: currentMode
            });

            // Lắng nghe answer
            database.ref(`rooms/${currentRoomId}/answer`).on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            // Lắng nghe ICE candidates
            database.ref(`rooms/${currentRoomId}/candidates/${partnerId}`).on('child_added', async (snapshot) => {
                try {
                    const candidate = new RTCIceCandidate(snapshot.val());
                    await peerConnection.addIceCandidate(candidate);
                } catch (error) {
                    console.error("Lỗi thêm ICE candidate:", error);
                }
            });
        }

        function listenForPartner() {
            waitingRef.on('child_added', async (snapshot) => {
                if (snapshot.key === userId) return;

                currentRoomId = `${snapshot.key}_${userId}`;
                const roomRef = database.ref(`rooms/${currentRoomId}`);

                roomRef.once('value', async (snapshot) => {
                    const data = snapshot.val();
                    if (data?.offer) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        await roomRef.update({ answer: answer });
                        
                        database.ref(`rooms/${currentRoomId}/candidates/${data.from}`).on('child_added', async (candidateSnapshot) => {
                            try {
                                const candidate = new RTCIceCandidate(candidateSnapshot.val());
                                await peerConnection.addIceCandidate(candidate);
                            } catch (error) {
                                console.error("Lỗi thêm ICE candidate:", error);
                            }
                        });
                    }
                });
            });
        }

        // ==================== IMPROVED DATA CHANNEL ====================
        function setupDataChannel() {
            if (!dataChannel) {
                dataChannel = peerConnection.createDataChannel('chat');
                
                dataChannel.onopen = () => {
                    isConnected = true;
                    updateStatusUI('connected');
                    document.getElementById('chat-container').classList.remove('hidden');
                    document.getElementById('end-btn').classList.remove('hidden');
                };

                dataChannel.onmessage = (event) => {
                    displayMessage(event.data, false);
                };

                dataChannel.onclose = () => {
                    handleDisconnect();
                };
            }
        }

        // ==================== IMPROVED CLEANUP ====================
        async function handleDisconnect() {
            try {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (currentRoomId) {
                    await database.ref(`rooms/${currentRoomId}`).remove();
                }
                if (waitingRef) {
                    await waitingRef.child(userId).remove();
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                isConnected = false;
                isWaiting = false;
                dataChannel = null;
                currentRoomId = null;
                
                updateStatusUI('idle');
                document.getElementById('end-btn').classList.add('hidden');
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('chat-container').classList.add('hidden');

                if (autoReconnect) setTimeout(startWaiting, 1000);
                
            } catch (error) {
                console.error("Lỗi khi ngắt kết nối:", error);
            }
        }

        // ==================== PHẦN CÒN LẠI GIỮ NGUYÊN ====================
    </script>
</body>
</html>
