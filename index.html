<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WebRTC Call - Manual Signaling</title>
  <!-- Import Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <style>
    video {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 150px;
      resize: none;
    }
    .sdp-section {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1 class="text-center">Cuộc Gọi Video &amp; Âm Thanh (Manual Signaling)</h1>
  <div class="row">
    <div class="col-md-6">
      <h4>Video của bạn</h4>
      <video id="localVideo" autoplay muted></video>
    </div>
    <div class="col-md-6">
      <h4>Video đối phương</h4>
      <video id="remoteVideo" autoplay></video>
    </div>
  </div>
  <hr>
  <div class="sdp-section">
    <h4>Local SDP (Copy &amp; gửi cho bên kia)</h4>
    <textarea id="localSDP" readonly></textarea>
    <button id="createOffer" class="btn btn-primary">Tạo Offer</button>
    <button id="createAnswer" class="btn btn-secondary">Tạo Answer (sau khi nhận Offer)</button>
  </div>
  <div class="sdp-section">
    <h4>Remote SDP (Dán SDP nhận được từ bên kia)</h4>
    <textarea id="remoteSDP"></textarea>
    <button id="setRemote" class="btn btn-success">Đặt Remote SDP</button>
  </div>
  <button id="endCall" class="btn btn-danger">Kết thúc cuộc gọi</button>
  <div id="status" class="mt-3"></div>
</div>

<script>
  let localStream;
  let peerConnection;
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const localSDPTextarea = document.getElementById("localSDP");
  const remoteSDPTextarea = document.getElementById("remoteSDP");
  const statusDiv = document.getElementById("status");

  // Cấu hình ICE server (sử dụng STUN của Google)
  const configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  // Lấy media từ camera và microphone của người dùng
  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      localStream = stream;
      localVideo.srcObject = stream;
    })
    .catch(err => {
      console.error("Lỗi khi truy cập media:", err);
      statusDiv.innerText = "Lỗi khi truy cập camera và microphone.";
    });

  function createPeerConnection() {
    peerConnection = new RTCPeerConnection(configuration);

    // Xử lý ICE candidate: khi gathering hoàn tất (candidate=null) thì hiển thị SDP
    peerConnection.onicecandidate = event => {
      if (event.candidate === null) {
        // ICE gathering đã hoàn tất, hiển thị SDP đã được setLocalDescription
        localSDPTextarea.value = JSON.stringify(peerConnection.localDescription);
        statusDiv.innerText = "SDP đã được tạo. Sao chép và gửi cho đối phương.";
      }
    };

    // Khi nhận được remote stream, hiển thị lên video của bên kia
    peerConnection.ontrack = event => {
      remoteVideo.srcObject = event.streams[0];
    };

    // Thêm các track từ local stream vào peerConnection
    if (localStream) {
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
    }
  }

  // Tạo offer và hiển thị SDP sau khi ICE gathering hoàn tất
  document.getElementById("createOffer").addEventListener("click", async () => {
    createPeerConnection();
    try {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      statusDiv.innerText = "Đang tạo offer, chờ ICE gathering hoàn tất...";
    } catch (err) {
      console.error("Lỗi khi tạo offer:", err);
      statusDiv.innerText = "Lỗi khi tạo offer.";
    }
  });

  // Tạo answer sau khi đã nhận offer từ đối phương
  document.getElementById("createAnswer").addEventListener("click", async () => {
    if (!peerConnection) {
      createPeerConnection();
    }
    try {
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      statusDiv.innerText = "Đang tạo answer, chờ ICE gathering hoàn tất...";
    } catch (err) {
      console.error("Lỗi khi tạo answer:", err);
      statusDiv.innerText = "Lỗi khi tạo answer.";
    }
  });

  // Đặt Remote SDP từ đối phương (bạn phải copy SDP nhận được và dán vào ô Remote SDP)
  document.getElementById("setRemote").addEventListener("click", async () => {
    const remoteSDP = remoteSDPTextarea.value;
    if (!remoteSDP) {
      alert("Vui lòng dán Remote SDP vào ô trống.");
      return;
    }
    try {
      const remoteDescription = new RTCSessionDescription(JSON.parse(remoteSDP));
      await peerConnection.setRemoteDescription(remoteDescription);
      statusDiv.innerText = "Đã đặt Remote SDP thành công.";
    } catch (err) {
      console.error("Lỗi khi đặt Remote SDP:", err);
      statusDiv.innerText = "Lỗi khi đặt Remote SDP. Kiểm tra lại định dạng.";
    }
  });

  // Kết thúc cuộc gọi
  document.getElementById("endCall").addEventListener("click", () => {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
      statusDiv.innerText = "Cuộc gọi đã kết thúc.";
      localSDPTextarea.value = "";
      remoteSDPTextarea.value = "";
    }
  });
</script>
</body>
</html>
