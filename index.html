<!DOCTYPE html>
<html>
<head>
    <title>Video Call</title>
    <meta charset="UTF-8">
    <style>
        #video-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        video {
            width: 400px;
            height: 300px;
            background: #000;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        input {
            padding: 8px;
            width: 200px;
        }
        button {
            padding: 8px 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div>
        <input type="text" id="callId" placeholder="Nhập ID cuộc gọi">
        <div class="controls">
            <button onclick="startCall()">Bắt đầu cuộc gọi</button>
            <button onclick="joinCall()">Tham gia cuộc gọi</button>
            <button onclick="hangUp()">Kết thúc</button>
        </div>
    </div>
    <div id="video-container">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <!-- Firebase và WebRTC adapter -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <script>
        // Khởi tạo Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBvxl_a9NurzYLnAfuYM1sHnfuCc03gjoA",
            authDomain: "waitcall-87f5e.firebaseapp.com",
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.firebasestorage.app",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let localStream;
        let remoteStream;
        let peerConnection;
        let callId;
        
        // Thiết lập kết nối WebRTC
        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // Khởi tạo stream video
        async function setupMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (error) {
                console.error('Lỗi truy cập thiết bị:', error);
            }
        }

        // Tạo peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);
            
            remoteStream = new MediaStream();
            document.getElementById('remoteVideo').srcObject = remoteStream;

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    database.ref(callId + '/candidates').push(event.candidate.toJSON());
                }
            };
        }

        // Bắt đầu cuộc gọi
        async function startCall() {
            await setupMedia();
            callId = document.getElementById('callId').value || Math.random().toString(36).substring(7);
            document.getElementById('callId').value = callId;
            
            createPeerConnection();
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            database.ref(callId).set({
                offer: offer,
                answer: null,
                candidates: {}
            });
            
            listenForAnswer();
        }

        // Tham gia cuộc gọi
        async function joinCall() {
            await setupMedia();
            callId = document.getElementById('callId').value;
            
            createPeerConnection();
            
            const callRef = database.ref(callId);
            callRef.once('value').then(async snapshot => {
                const data = snapshot.val();
                if (data.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    callRef.update({ answer: answer });
                }
            });
            
            listenForCandidates();
        }

        // Lắng nghe answer từ peer
        function listenForAnswer() {
            database.ref(callId + '/answer').on('value', async snapshot => {
                const answer = snapshot.val();
                if (answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });
            
            listenForCandidates();
        }

        // Lắng nghe ICE candidates
        function listenForCandidates() {
            database.ref(callId + '/candidates').on('child_added', snapshot => {
                const candidate = new RTCIceCandidate(snapshot.val());
                peerConnection.addIceCandidate(candidate);
            });
        }

        // Kết thúc cuộc gọi
        function hangUp() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (callId) {
                database.ref(callId).remove();
                callId = null;
            }
            localStream.getTracks().forEach(track => track.stop());
            document.getElementById('callId').value = '';
        }

        // Khởi tạo khi trang web load xong
        window.onload = setupMedia;
    </script>
</body>
</html>
