<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaitCall - Tr√≤ chuy·ªán ng·∫´u nhi√™n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #ecf0f1;
        }
        .mode-btn.active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-box {
            width: 400px;
            height: 300px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .audio-mode .video-box {
            background-color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .wait-btn {
            background-color: #3498db;
            color: white;
        }
        .wait-btn:hover {
            background-color: #2980b9;
        }
        .end-btn {
            background-color: #e74c3c;
            color: white;
        }
        .end-btn:hover {
            background-color: #c0392b;
        }
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #ecf0f1;
        }
        .waiting {
            background-color: #f39c12;
            color: white;
        }
        .connected {
            background-color: #2ecc71;
            color: white;
        }
        .hidden {
            display: none;
        }
        .username {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: white;
        }
        .chat-input-container {
            display: flex;
            padding: 10px;
            background-color: #ecf0f1;
        }
        .chat-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .send-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .sent {
            background-color: #3498db;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .received {
            background-color: #ecf0f1;
            align-self: flex-start;
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .audio-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto;
        }
        .speaking {
            background-color: #2ecc71;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .mode-container {
            margin-bottom: 20px;
        }
        .mode-label {
            display: block;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WaitCall</h1>
            <p>Tr√≤ chuy·ªán v·ªõi ng∆∞·ªùi l·∫°</p>
        </header>

        <div class="mode-selector">
            <button id="videoMode" class="mode-btn active">Video Call</button>
            <button id="audioMode" class="mode-btn">Audio Call</button>
            <button id="chatMode" class="mode-btn">Chat</button>
        </div>

        <div class="status" id="statusMessage">
            Ch√†o m·ª´ng ƒë·∫øn v·ªõi WaitCall. Nh·∫•n "B·∫Øt ƒë·∫ßu t√¨m ki·∫øm" ƒë·ªÉ k·∫øt n·ªëi.
        </div>

        <div class="mode-container" id="videoContainer">
            <div class="video-container">
                <div class="video-box">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="username">B·∫°n</div>
                </div>
                <div class="video-box">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="username">Ng∆∞·ªùi l·∫°</div>
                </div>
            </div>
        </div>

        <div class="mode-container hidden" id="audioContainer">
            <div class="video-container audio-mode">
                <div class="video-box">
                    <div class="audio-indicator" id="localAudioIndicator">
                        <i class="fas">üé§</i>
                    </div>
                    <div class="username">B·∫°n</div>
                </div>
                <div class="video-box">
                    <div class="audio-indicator" id="remoteAudioIndicator">
                        <i class="fas">üé§</i>
                    </div>
                    <div class="username">Ng∆∞·ªùi l·∫°</div>
                </div>
            </div>
        </div>

        <div class="mode-container hidden" id="chatContainer">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                    <button class="send-btn" id="sendButton">G·ª≠i</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="waitButton" class="wait-btn">B·∫Øt ƒë·∫ßu t√¨m ki·∫øm</button>
            <button id="endButton" class="end-btn hidden">K·∫øt th√∫c</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            authDomain: "waitcall-87f5e.firebaseapp.com",
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.firebasestorage.app",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Bi·∫øn to√†n c·ª•c
        let localStream;
        let peerConnection;
        let dataChannel;
        let userId;
        let roomId;
        let waitingRef;
        let roomRef;
        let currentStatus = 'idle'; // idle, waiting, connected
        let currentMode = 'video'; // video, audio, chat
        let audioContext;
        let audioAnalyser;
        let remoteAudioAnalyser;
        let audioDetectionInterval;

        // Elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const waitButton = document.getElementById('waitButton');
        const endButton = document.getElementById('endButton');
        const statusMessage = document.getElementById('statusMessage');
        const videoModeBtn = document.getElementById('videoMode');
        const audioModeBtn = document.getElementById('audioMode');
        const chatModeBtn = document.getElementById('chatMode');
        const videoContainer = document.getElementById('videoContainer');
        const audioContainer = document.getElementById('audioContainer');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const localAudioIndicator = document.getElementById('localAudioIndicator');
        const remoteAudioIndicator = document.getElementById('remoteAudioIndicator');

        // ICE servers cho WebRTC
        const servers = {
            iceServers: [
                {
                    urls: [
                        'stun:stun1.l.google.com:19302',
                        'stun:stun2.l.google.com:19302',
                    ],
                },
            ],
        };

        // Kh·ªüi t·∫°o
        async function init() {
            try {
                // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c ch·∫ø ƒë·ªô
                videoModeBtn.addEventListener('click', () => switchMode('video'));
                audioModeBtn.addEventListener('click', () => switchMode('audio'));
                chatModeBtn.addEventListener('click', () => switchMode('chat'));
                waitButton.addEventListener('click', startWaiting);
                endButton.addEventListener('click', endCall);
                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                // Thi·∫øt l·∫≠p AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // S·ª± ki·ªán khi ng∆∞·ªùi d√πng ƒë√≥ng tab
                window.addEventListener('beforeunload', cleanup);

                // Kh·ªüi t·∫°o ID ng∆∞·ªùi d√πng
                userId = generateUserId();
                console.log('User ID:', userId);

                // Kh·ªüi t·∫°o ch·∫ø ƒë·ªô m·∫∑c ƒë·ªãnh (video)
                await switchMode('video');
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o:', error);
                statusMessage.textContent = 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng.';
                statusMessage.style.backgroundColor = '#e74c3c';
            }
        }

        // Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô giao ti·∫øp
        async function switchMode(mode) {
            if (currentStatus === 'connected') {
                await endCall();
            }

            currentMode = mode;
            
            // C·∫≠p nh·∫≠t UI
            videoModeBtn.classList.remove('active');
            audioModeBtn.classList.remove('active');
            chatModeBtn.classList.remove('active');
            videoContainer.classList.add('hidden');
            audioContainer.classList.add('hidden');
            chatContainer.classList.add('hidden');
            
            // X√≥a stream hi·ªán t·∫°i n·∫øu c√≥
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Thi·∫øt l·∫≠p ch·∫ø ƒë·ªô ƒë∆∞·ª£c ch·ªçn
            if (mode === 'video') {
                videoModeBtn.classList.add('active');
                videoContainer.classList.remove('hidden');
                // L·∫•y c·∫£ video v√† audio
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true,
                });
                localVideo.srcObject = localStream;
            } else if (mode === 'audio') {
                audioModeBtn.classList.add('active');
                audioContainer.classList.remove('hidden');
                // Ch·ªâ l·∫•y audio
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true,
                });
                setupAudioVisualizer(localStream);
            } else if (mode === 'chat') {
                chatModeBtn.classList.add('active');
                chatContainer.classList.remove('hidden');
                // Kh√¥ng c·∫ßn media stream
                chatMessages.innerHTML = '';
            }
        }

        // Thi·∫øt l·∫≠p hi·ªáu ·ª©ng √¢m thanh
        function setupAudioVisualizer(stream) {
            if (!audioContext) return;
            
            // Ng·∫Øt ƒëo √¢m l∆∞·ª£ng c≈© n·∫øu c√≥
            if (audioDetectionInterval) {
                clearInterval(audioDetectionInterval);
            }
            
            // T·∫°o ph√¢n t√≠ch √¢m thanh
            const audioSource = audioContext.createMediaStreamSource(stream);
            audioAnalyser = audioContext.createAnalyser();
            audioAnalyser.fftSize = 256;
            audioSource.connect(audioAnalyser);
            
            // Kh·ªüi t·∫°o buffer ƒë·ªÉ ph√¢n t√≠ch √¢m thanh
            const bufferLength = audioAnalyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // ƒêo v√† hi·ªÉn th·ªã √¢m l∆∞·ª£ng ƒë·ªãnh k·ª≥
            audioDetectionInterval = setInterval(() => {
                if (!audioAnalyser) return;
                
                audioAnalyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                
                // Hi·ªáu ·ª©ng khi n√≥i
                if (average > 20) {
                    localAudioIndicator.classList.add('speaking');
                } else {
                    localAudioIndicator.classList.remove('speaking');
                }
            }, 100);
        }

        // Thi·∫øt l·∫≠p hi·ªáu ·ª©ng √¢m thanh cho ng∆∞·ªùi g·ªçi t·ª´ xa
        function setupRemoteAudioVisualizer() {
            if (!audioContext || !remoteVideo.srcObject) return;
            
            const remoteStream = remoteVideo.srcObject;
            const audioSource = audioContext.createMediaStreamSource(remoteStream);
            remoteAudioAnalyser = audioContext.createAnalyser();
            remoteAudioAnalyser.fftSize = 256;
            audioSource.connect(remoteAudioAnalyser);
            
            const bufferLength = remoteAudioAnalyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            setInterval(() => {
                if (!remoteAudioAnalyser) return;
                
                remoteAudioAnalyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                
                if (average > 20) {
                    remoteAudioIndicator.classList.add('speaking');
                } else {
                    remoteAudioIndicator.classList.remove('speaking');
                }
            }, 100);
        }

        // T·∫°o ID ng·∫´u nhi√™n
        function generateUserId() {
            return Math.random().toString(36).substring(2, 15);
        }

        // B·∫Øt ƒë·∫ßu ch·ªù
        async function startWaiting() {
            if (currentStatus !== 'idle') return;

            updateStatus('waiting');
            waitButton.classList.add('hidden');
            endButton.classList.remove('hidden');
            statusMessage.textContent = 'ƒêang t√¨m ki·∫øm ng∆∞·ªùi tr√≤ chuy·ªán...';
            statusMessage.classList.add('waiting');

            // Th√™m th√¥ng tin ch·∫ø ƒë·ªô v√†o danh s√°ch ch·ªù
            waitingRef = database.ref('waiting');
            
            try {
                // T√¨m ng∆∞·ªùi ƒëang ch·ªù v·ªõi c√πng ch·∫ø ƒë·ªô
                const snapshot = await waitingRef.orderByChild('mode').equalTo(currentMode).once('value');
                const waitingUsers = snapshot.val() || {};
                const waitingUserIds = Object.keys(waitingUsers).filter(id => id !== userId);
                
                if (waitingUserIds.length > 0) {
                    // C√≥ ng∆∞·ªùi ƒëang ch·ªù, t·∫°o ph√≤ng
                    const partnerId = waitingUserIds[0];
                    await waitingRef.child(partnerId).remove();
                    createRoom(partnerId);
                } else {
                    // Kh√¥ng c√≥ ai ƒëang ch·ªù, th√™m v√†o danh s√°ch ch·ªù
                    await waitingRef.child(userId).set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        mode: currentMode
                    });
                    
                    // L·∫Øng nghe s·ª± ki·ªán khi c√≥ ph√≤ng m·ªõi
                    listenForRoomCreation();
                }
            } catch (error) {
                console.error('L·ªói khi t√¨m ki·∫øm ƒë·ªëi t√°c:', error);
                updateStatus('idle');
            }
        }

        // L·∫Øng nghe s·ª± ki·ªán t·∫°o ph√≤ng
        function listenForRoomCreation() {
            database.ref('rooms').orderByChild('participants/' + userId).equalTo(true)
                .on('child_added', async (snapshot) => {
                    // C√≥ ph√≤ng m·ªõi ƒë∆∞·ª£c t·∫°o v·ªõi ng∆∞·ªùi d√πng n√†y
                    roomId = snapshot.key;
                    console.log('Ph√≤ng m·ªõi ƒë∆∞·ª£c t·∫°o:', roomId);
                    
                    // X√≥a kh·ªèi danh s√°ch ch·ªù
                    if (waitingRef) {
                        await waitingRef.child(userId).remove();
                    }
                    
                    // Tham gia ph√≤ng
                    joinRoom(roomId);
                });
        }

        // T·∫°o ph√≤ng m·ªõi
        async function createRoom(partnerId) {
            roomId = `room_${userId}_${partnerId}_${currentMode}`;
            roomRef = database.ref('rooms/' + roomId);
            
            // Thi·∫øt l·∫≠p th√¥ng tin ph√≤ng
            await roomRef.set({
                created: firebase.database.ServerValue.TIMESTAMP,
                mode: currentMode,
                participants: {
                    [userId]: true,
                    [partnerId]: true
                }
            });
            
            // T·∫°o k·∫øt n·ªëi WebRTC
            setupPeerConnection();
            
            // T·∫°o v√† g·ª≠i offer
            createAndSendOffer();
        }

        // Tham gia ph√≤ng
        function joinRoom(roomIdToJoin) {
            roomId = roomIdToJoin;
            roomRef = database.ref('rooms/' + roomId);
            
            // Ki·ªÉm tra ch·∫ø ƒë·ªô c·ªßa ph√≤ng
            roomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                if (roomData && roomData.mode !== currentMode) {
                    // N·∫øu ch·∫ø ƒë·ªô kh√¥ng kh·ªõp, chuy·ªÉn sang ch·∫ø ƒë·ªô c·ªßa ph√≤ng
                    switchMode(roomData.mode).then(() => {
                        // Thi·∫øt l·∫≠p k·∫øt n·ªëi WebRTC
                        setupPeerConnection();
                        
                        // L·∫Øng nghe offer v√† answer
                        listenForRemoteSessionDescriptions();
                    });
                } else {
                    // Thi·∫øt l·∫≠p k·∫øt n·ªëi WebRTC
                    setupPeerConnection();
                    
                    // L·∫Øng nghe offer v√† answer
                    listenForRemoteSessionDescriptions();
                }
            });
        }

        // Thi·∫øt l·∫≠p k·∫øt n·ªëi ngang h√†ng WebRTC
        function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);
            
            // Th√™m lu·ªìng local v√†o k·∫øt n·ªëi (n·∫øu c√≥)
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // Thi·∫øt l·∫≠p k√™nh d·ªØ li·ªáu n·∫øu l√† ch·∫ø ƒë·ªô chat
            if (currentMode === 'chat') {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel(dataChannel);
                
                peerConnection.ondatachannel = event => {
                    setupDataChannel(event.channel);
                };
            }
            
            // L·∫Øng nghe khi c√≥ lu·ªìng remote
            peerConnection.ontrack = event => {
                if (currentMode === 'video') {
                    remoteVideo.srcObject = event.streams[0];
                } else if (currentMode === 'audio') {
                    remoteVideo.srcObject = event.streams[0];
                    // Thi·∫øt l·∫≠p hi·ªáu ·ª©ng √¢m thanh cho ng∆∞·ªùi g·ªçi t·ª´ xa
                    setupRemoteAudioVisualizer();
                }
                updateStatus('connected');
            };
            
            // L·∫Øng nghe c√°c ·ª©ng c·ª≠ vi√™n ICE
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    roomRef.child('candidates/' + userId).push(event.candidate.toJSON());
                }
            };
            
            // L·∫Øng nghe c√°c ·ª©ng c·ª≠ vi√™n ICE t·ª´ ƒë·ªëi t√°c
            roomRef.child('candidates').on('child_added', snapshot => {
                if (snapshot.key !== userId) {
                    snapshot.forEach(childSnapshot => {
                        const candidate = new RTCIceCandidate(childSnapshot.val());
                        peerConnection.addIceCandidate(candidate);
                    });
                }
            });
        }

        // Thi·∫øt l·∫≠p k√™nh d·ªØ li·ªáu cho chat
        function setupDataChannel(channel) {
            dataChannel = channel;
            
            dataChannel.onopen = () => {
                console.log('K√™nh d·ªØ li·ªáu ƒë√£ m·ªü');
                chatInput.disabled = false;
            };
            
            dataChannel.onclose = () => {
                console.log('K√™nh d·ªØ li·ªáu ƒë√£ ƒë√≥ng');
                chatInput.disabled = true;
            };
            
            dataChannel.onmessage = event => {
                displayMessage(event.data, false);
            };
        }

        // G·ª≠i tin nh·∫Øn chat
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || !dataChannel || dataChannel.readyState !== 'open') return;
            
            dataChannel.send(message);
            displayMessage(message, true);
            chatInput.value = '';
        }

        // Hi·ªÉn th·ªã tin nh·∫Øn chat
        function displayMessage(message, isSent) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isSent ? 'sent' : 'received');
            messageElement.textContent = message;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // T·∫°o v√† g·ª≠i offer
        async function createAndSendOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                const roomWithOffer = {
                    offer: {
                        type: offer.type,
                        sdp: offer.sdp
                    }
                };
                
                await roomRef.update(roomWithOffer);
                listenForRemoteSessionDescriptions();
            } catch (error) {
                console.error('L·ªói khi t·∫°o offer:', error);
            }
        }

        // L·∫Øng nghe m√¥ t·∫£ phi√™n t·ª´ xa
        function listenForRemoteSessionDescriptions() {
            roomRef.on('value', async snapshot => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                // X·ª≠ l√Ω answer khi l√† ng∆∞·ªùi t·∫°o offer
                if (peerConnection.localDescription && peerConnection.localDescription.type === 'offer' && roomData.answer) {
                    const remoteAnswer = new RTCSessionDescription(roomData.answer);
                    if (peerConnection.currentRemoteDescription === null) {
                        await peerConnection.setRemoteDescription(remoteAnswer);
                    }
                }
                
                // X·ª≠ l√Ω offer khi l√† ng∆∞·ªùi nh·∫≠n
                else if (!peerConnection.localDescription && roomData.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(roomData.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    const roomWithAnswer = {
                        answer: {
                            type: answer.type,
                            sdp: answer.sdp
                        }
                    };
                    
                    await roomRef.update(roomWithAnswer);
                }
            });
        }

        // K·∫øt th√∫c cu·ªôc g·ªçi
        async function endCall() {
            // ƒê√≥ng k·∫øt n·ªëi hi·ªán t·∫°i
            await cleanup();
            
            // C·∫≠p nh·∫≠t UI
            updateStatus('idle');
        }

        // D·ªçn d·∫πp t√†i nguy√™n
        async function cleanup() {
            currentStatus = 'idle';
            
            // D·ª´ng ph√¢n t√≠ch √¢m thanh
            if (audioDetectionInterval) {
                clearInterval(audioDetectionInterval);
                audioDetectionInterval = null;
            }
            
            // D·ª´ng l·∫Øng nghe c√°c s·ª± ki·ªán Firebase
            if (roomRef) {
                roomRef.off();
                await roomRef.remove();
            }
            
            if (waitingRef && userId) {
                await waitingRef.child(userId).remove();
                database.ref('rooms').off();
            }
            
            // ƒê√≥ng k·∫øt n·ªëi WebRTC
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // ƒê√≥ng k√™nh d·ªØ li·ªáu
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            
            // X√≥a lu·ªìng video
            if (currentMode === 'video' || currentMode === 'audio') {
                remoteVideo.srcObject = null;
            }
            
            // X√≥a tin nh·∫Øn chat
            if (currentMode === 'chat') {
                chatMessages.innerHTML = '';
                chatInput.disabled = true;
            }
            
            // C·∫≠p nh·∫≠t UI
            waitButton.classList.remove('hidden');
            endButton.classList.add('hidden');
            statusMessage.textContent = 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi WaitCall. Nh·∫•n "B·∫Øt ƒë·∫ßu t√¨m ki·∫øm" ƒë·ªÉ k·∫øt n·ªëi.';
            statusMessage.classList.remove('waiting', 'connected');
            localAudioIndicator.classList.remove('speaking');
            remoteAudioIndicator.classList.remove('speaking');
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(status) {
            currentStatus = status;
            
            if (status === 'waiting') {
                waitButton.classList.add('hidden');
                endButton.classList.remove('hidden');
                statusMessage.textContent = 'ƒêang t√¨m ki·∫øm ng∆∞·ªùi tr√≤ chuy·ªán...';
                statusMessage.classList.add('waiting');
                statusMessage.classList.remove('connected');
            } else if (status === 'connected') {
                waitButton.classList.add('hidden');
                endButton.classList.remove('hidden');
                
                let modeText = '';
                if (currentMode === 'video') modeText = 'video';
                else if (currentMode === 'audio') modeText = 'audio';
                else modeText = 'chat';
                
                statusMessage.textContent = `ƒê√£ k·∫øt n·ªëi v·ªõi ng∆∞·ªùi l·∫° qua ${modeText}. B·∫°n c√≥ th·ªÉ tr√≤ chuy·ªán ngay b√¢y gi·ªù.`;
                statusMessage.classList.remove('waiting');
                statusMessage.classList.add('connected');
                
                if (currentMode === 'chat') {
                    chatInput.disabled = false;
                    chatInput.focus();
                }
            } else { // idle
                waitButton.classList.remove('hidden');
                endButton.classList.add('hidden');
                statusMessage.textContent = 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi WaitCall. Nh·∫•n "B·∫Øt ƒë·∫ßu t√¨m ki·∫øm" ƒë·ªÉ k·∫øt n·ªëi.';
                statusMessage.classList.remove('waiting', 'connected');
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
