<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phòng Chơi Game Trực Tuyến</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 50px;
        }
        .player-list {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }
        .player-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        .player-item.current-user {
            background-color: #d1e7dd;
        }
        .player-item.online {
            border-left: 4px solid #28a745;
        }
        .player-item.offline {
            border-left: 4px solid #dc3545;
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }
        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.own-message {
            background-color: #cfe2ff;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .chat-message.other-message {
            background-color: #e9ecef;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .score-board {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .game-cell {
            height: 100px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .game-cell:hover {
            background-color: #e9ecef;
        }
        .game-cell.clicked {
            pointer-events: none;
        }
        .game-status {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            height: 24px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-container">
            <h1 class="text-center mb-4">Phòng Chơi Game Trực Tuyến</h1>
            
            <!-- Đăng nhập -->
            <div id="loginSection" class="mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Đăng nhập để bắt đầu</h5>
                        <div class="mb-3">
                            <label for="playerName" class="form-label">Tên người chơi</label>
                            <input type="text" class="form-control" id="playerName" placeholder="Nhập tên của bạn">
                        </div>
                        <button id="loginBtn" class="btn btn-primary">Đăng nhập</button>
                    </div>
                </div>
            </div>

            <!-- Khu vực chơi game -->
            <div id="gameSection" class="hidden">
                <div class="row">
                    <div class="col-md-4">
                        <h5>Người chơi trực tuyến</h5>
                        <div class="player-list" id="playerList">
                            <!-- Danh sách người chơi sẽ được thêm ở đây -->
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="game-status" id="gameStatus"></div>
                        <div class="score-board">
                            <h5>Bảng điểm</h5>
                            <div id="scoreBoard">
                                <!-- Điểm số sẽ được thêm ở đây -->
                            </div>
                        </div>

                        <div class="game-action mb-3">
                            <button id="createGameBtn" class="btn btn-success">Tạo trò chơi mới</button>
                            <button id="joinGameBtn" class="btn btn-primary">Tham gia trò chơi</button>
                            <button id="spectateBtn" class="btn btn-secondary">Theo dõi</button>
                        </div>
                        
                        <div class="game-board" id="gameBoard">
                            <div class="game-cell" data-index="0"></div>
                            <div class="game-cell" data-index="1"></div>
                            <div class="game-cell" data-index="2"></div>
                            <div class="game-cell" data-index="3"></div>
                            <div class="game-cell" data-index="4"></div>
                            <div class="game-cell" data-index="5"></div>
                            <div class="game-cell" data-index="6"></div>
                            <div class="game-cell" data-index="7"></div>
                            <div class="game-cell" data-index="8"></div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h5>Trò chuyện</h5>
                        <div class="chat-container" id="chatContainer">
                            <!-- Tin nhắn chat sẽ được thêm ở đây -->
                        </div>
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="Nhập tin nhắn...">
                            <button class="btn btn-primary" id="sendChatBtn">Gửi</button>
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <button id="logoutBtn" class="btn btn-danger">Đăng xuất</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBmNXcZQ8EMFxu-xTrBWmQBQMSCJzk9FPQ",
            authDomain: "waitcall-87f5e.firebaseapp.com",
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.firebasestorage.app",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Các biến toàn cục
        let currentPlayer = null;
        let currentPlayerId = null;
        let currentGameId = null;
        let isMyTurn = false;
        let playerSymbol = '';

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const gameSection = document.getElementById('gameSection');
        const playerNameInput = document.getElementById('playerName');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const playerList = document.getElementById('playerList');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const spectateBtn = document.getElementById('spectateBtn');
        const gameBoard = document.getElementById('gameBoard');
        const gameCells = document.querySelectorAll('.game-cell');
        const gameStatus = document.getElementById('gameStatus');
        const scoreBoard = document.getElementById('scoreBoard');

        // Bắt sự kiện khi trang được tải
        window.onload = function() {
            checkLocalStorage();
            setupEventListeners();
        };

        // Kiểm tra xem người dùng đã đăng nhập chưa
        function checkLocalStorage() {
            const savedPlayer = localStorage.getItem('currentPlayer');
            const savedPlayerId = localStorage.getItem('currentPlayerId');
            
            if (savedPlayer && savedPlayerId) {
                currentPlayer = savedPlayer;
                currentPlayerId = savedPlayerId;
                showGameSection();
                updatePlayerStatus(true);
                loadPlayers();
                loadMessages();
                loadGames();
            }
        }

        // Thiết lập các event listener
        function setupEventListeners() {
            // Đăng nhập
            loginBtn.addEventListener('click', login);
            
            // Đăng xuất
            logoutBtn.addEventListener('click', logout);
            
            // Gửi tin nhắn
            sendChatBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Tạo và tham gia trò chơi
            createGameBtn.addEventListener('click', createGame);
            joinGameBtn.addEventListener('click', joinGame);
            spectateBtn.addEventListener('click', spectateGame);
            
            // Sự kiện click trên bảng trò chơi
            gameCells.forEach(cell => {
                cell.addEventListener('click', () => {
                    if (isMyTurn && !cell.classList.contains('clicked')) {
                        const index = cell.getAttribute('data-index');
                        makeMove(index);
                    }
                });
            });

            // Xử lý sự kiện khi người dùng đóng tab/trình duyệt
            window.addEventListener('beforeunload', () => {
                if (currentPlayerId) {
                    updatePlayerStatus(false);
                }
            });
        }

        // Đăng nhập
        function login() {
            const playerName = playerNameInput.value.trim();
            
            if (playerName) {
                const playerId = generatePlayerId();
                currentPlayer = playerName;
                currentPlayerId = playerId;
                
                // Lưu vào localStorage
                localStorage.setItem('currentPlayer', playerName);
                localStorage.setItem('currentPlayerId', playerId);
                
                // Thêm người chơi vào database
                database.ref('players/' + playerId).set({
                    name: playerName,
                    online: true,
                    score: 0,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                showGameSection();
                loadPlayers();
                loadMessages();
                loadGames();
            } else {
                alert('Vui lòng nhập tên người chơi!');
            }
        }

        // Đăng xuất
        function logout() {
            if (currentPlayerId) {
                updatePlayerStatus(false);
                
                // Xóa khỏi localStorage
                localStorage.removeItem('currentPlayer');
                localStorage.removeItem('currentPlayerId');
                
                // Reset biến toàn cục
                currentPlayer = null;
                currentPlayerId = null;
                currentGameId = null;
                
                // Hiển thị lại form đăng nhập
                loginSection.classList.remove('hidden');
                gameSection.classList.add('hidden');
            }
        }

        // Tạo ID người chơi
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        // Hiển thị phần chơi game
        function showGameSection() {
            loginSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
        }

        // Cập nhật trạng thái người chơi (online/offline)
        function updatePlayerStatus(isOnline) {
            if (currentPlayerId) {
                database.ref('players/' + currentPlayerId + '/online').set(isOnline);
                
                // Thiết lập trạng thái disconnect handler
                if (isOnline) {
                    database.ref('players/' + currentPlayerId + '/online').onDisconnect().set(false);
                }
            }
        }

        // Tải danh sách người chơi
        function loadPlayers() {
            database.ref('players').on('value', snapshot => {
                const players = snapshot.val() || {};
                renderPlayerList(players);
            });
        }

        // Hiển thị danh sách người chơi
        function renderPlayerList(players) {
            playerList.innerHTML = '';
            
            Object.keys(players).forEach(playerId => {
                const player = players[playerId];
                const playerElement = document.createElement('div');
                playerElement.classList.add('player-item');
                
                // Thêm class dựa trên trạng thái
                if (player.online) {
                    playerElement.classList.add('online');
                } else {
                    playerElement.classList.add('offline');
                }
                
                // Đánh dấu người chơi hiện tại
                if (playerId === currentPlayerId) {
                    playerElement.classList.add('current-user');
                }
                
                playerElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${player.name} ${playerId === currentPlayerId ? '(Bạn)' : ''}</span>
                        <span class="badge ${player.online ? 'bg-success' : 'bg-danger'}">
                            ${player.online ? 'Online' : 'Offline'}
                        </span>
                    </div>
                    <div>Điểm: ${player.score || 0}</div>
                `;
                
                playerList.appendChild(playerElement);
            });
        }

        // Gửi tin nhắn
        function sendMessage() {
            const message = chatInput.value.trim();
            
            if (message && currentPlayer) {
                database.ref('messages').push({
                    playerId: currentPlayerId,
                    playerName: currentPlayer,
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                chatInput.value = '';
            }
        }

        // Tải tin nhắn
        function loadMessages() {
            database.ref('messages').orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
                const messages = snapshot.val() || {};
                renderMessages(messages);
            });
        }

        // Hiển thị tin nhắn
        function renderMessages(messages) {
            chatContainer.innerHTML = '';
            
            Object.keys(messages).forEach(messageId => {
                const message = messages[messageId];
                const messageElement = document.createElement('div');
                
                // Xác định loại tin nhắn (của mình hay người khác)
                if (message.playerId === currentPlayerId) {
                    messageElement.classList.add('chat-message', 'own-message');
                } else {
                    messageElement.classList.add('chat-message', 'other-message');
                }
                
                messageElement.innerHTML = `
                    <div>
                        <strong>${message.playerName}:</strong>
                        <span>${message.message}</span>
                    </div>
                `;
                
                chatContainer.appendChild(messageElement);
            });
            
            // Cuộn xuống tin nhắn mới nhất
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Tạo trò chơi mới
        function createGame() {
            const gameId = 'game_' + Date.now();
            
            database.ref('games/' + gameId).set({
                creator: {
                    id: currentPlayerId,
                    name: currentPlayer
                },
                status: 'waiting',
                board: ['', '', '', '', '', '', '', '', ''],
                currentTurn: currentPlayerId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            currentGameId = gameId;
            playerSymbol = 'X';
            isMyTurn = true;
            
            joinCurrentGame();
        }

        // Tham gia trò chơi đang chờ
        function joinGame() {
            database.ref('games').orderByChild('status').equalTo('waiting').once('value', snapshot => {
                const games = snapshot.val();
                
                if (games) {
                    const gameIds = Object.keys(games);
                    const randomGame = games[gameIds[0]];
                    
                    // Kiểm tra xem có phải mình tạo không
                    if (randomGame.creator.id !== currentPlayerId) {
                        currentGameId = gameIds[0];
                        playerSymbol = 'O';
                        
                        // Cập nhật trò chơi
                        database.ref('games/' + currentGameId).update({
                            opponent: {
                                id: currentPlayerId,
                                name: currentPlayer
                            },
                            status: 'playing'
                        });
                        
                        isMyTurn = randomGame.currentTurn === currentPlayerId;
                        joinCurrentGame();
                    } else {
                        alert('Không thể tìm thấy trò chơi phù hợp để tham gia!');
                    }
                } else {
                    alert('Không có trò chơi nào đang chờ. Hãy tạo một trò chơi mới!');
                }
            });
        }

        // Xem trò chơi
        function spectateGame() {
            database.ref('games').orderByChild('status').equalTo('playing').once('value', snapshot => {
                const games = snapshot.val();
                
                if (games) {
                    const gameIds = Object.keys(games);
                    currentGameId = gameIds[0];
                    isMyTurn = false;
                    playerSymbol = '';
                    
                    joinCurrentGame(true);
                } else {
                    alert('Không có trò chơi nào đang diễn ra để theo dõi!');
                }
            });
        }

        // Tham gia trò chơi hiện tại
        function joinCurrentGame(isSpectator = false) {
            if (!currentGameId) return;
            
            // Theo dõi thay đổi trong trò chơi
            database.ref('games/' + currentGameId).on('value', snapshot => {
                const game = snapshot.val();
                
                if (game) {
                    renderGame(game, isSpectator);
                }
            });
        }

        // Tải danh sách trò chơi
        function loadGames() {
            database.ref('games').orderByChild('timestamp').limitToLast(5).on('value', snapshot => {
                const games = snapshot.val() || {};
                updateScoreBoard(games);
            });
        }

        // Cập nhật bảng điểm
        function updateScoreBoard(games) {
            scoreBoard.innerHTML = '';
            
            Object.keys(games).forEach(gameId => {
                const game = games[gameId];
                
                if (game.status === 'completed') {
                    const scoreElement = document.createElement('div');
                    scoreElement.classList.add('mb-2');
                    
                    scoreElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>${game.creator.name}</span>
                            <span>vs</span>
                            <span>${game.opponent ? game.opponent.name : 'N/A'}</span>
                        </div>
                        <div class="text-muted small">
                            ${game.winner ? 'Người thắng: ' + (game.winner.name || 'Hòa') : 'Đang chơi'}
                        </div>
                    `;
                    
                    scoreBoard.appendChild(scoreElement);
                }
            });
            
            if (scoreBoard.innerHTML === '') {
                scoreBoard.innerHTML = '<div class="text-muted">Chưa có trò chơi nào hoàn thành.</div>';
            }
        }

        // Hiển thị trò chơi
        function renderGame(game, isSpectator) {
            // Hiển thị trạng thái trò chơi
            if (game.status === 'waiting') {
                gameStatus.textContent = 'Đang chờ người chơi khác tham gia...';
            } else if (game.status === 'playing') {
                if (!isSpectator) {
                    if (game.currentTurn === currentPlayerId) {
                        gameStatus.textContent = 'Đến lượt của bạn!';
                        isMyTurn = true;
                    } else {
                        gameStatus.textContent = 'Đến lượt đối thủ...';
                        isMyTurn = false;
                    }
                } else {
                    const currentPlayerName = game.currentTurn === game.creator.id ? 
                        game.creator.name : (game.opponent ? game.opponent.name : 'Người chơi khác');
                    gameStatus.textContent = `Đến lượt của ${currentPlayerName}`;
                }
            } else if (game.status === 'completed') {
                if (game.winner) {
                    if (!isSpectator) {
                        if (game.winner.id === currentPlayerId) {
                            gameStatus.textContent = 'Bạn thắng!';
                        } else {
                            gameStatus.textContent = 'Bạn thua!';
                        }
                    } else {
                        gameStatus.textContent = `${game.winner.name} thắng!`;
                    }
                } else {
                    gameStatus.textContent = 'Trò chơi hòa!';
                }
            }
            
            // Cập nhật bảng trò chơi
            for (let i = 0; i < 9; i++) {
                const cell = gameCells[i];
                const value = game.board[i];
                
                if (value) {
                    cell.textContent = value;
                    cell.classList.add('clicked');
                } else {
                    cell.textContent = '';
                    cell.classList.remove('clicked');
                }
            }
        }

        // Thực hiện nước đi
        function makeMove(index) {
            if (!currentGameId || !isMyTurn) return;
            
            // Lấy trạng thái hiện tại của trò chơi
            database.ref('games/' + currentGameId).once('value', snapshot => {
                const game = snapshot.val();
                
                if (game && game.status === 'playing' && game.currentTurn === currentPlayerId) {
                    const board = [...game.board];
                    
                    // Kiểm tra xem ô đã được đánh chưa
                    if (board[index] === '') {
                        board[index] = playerSymbol;
                        
                        // Cập nhật lượt chơi tiếp theo
                        const nextTurn = game.creator.id === currentPlayerId ? 
                            (game.opponent ? game.opponent.id : '') : game.creator.id;
                        
                        // Kiểm tra trạng thái trò chơi
                        const gameResult = checkGameStatus(board);
                        
                        if (gameResult.status === 'win') {
                            // Cập nhật người thắng
                            database.ref('games/' + currentGameId).update({
                                board: board,
                                status: 'completed',
                                winner: {
                                    id: currentPlayerId,
                                    name: currentPlayer
                                }
                            });
                            
                            // Cập nhật điểm
                            database.ref('players/' + currentPlayerId + '/score').transaction(score => {
                                return (score || 0) + 1;
                            });
                        } else if (gameResult.status === 'draw') {
                            // Cập nhật kết quả hòa
                            database.ref('games/' + currentGameId).update({
                                board: board,
                                status: 'completed',
                                winner: null
                            });
                        } else {
                            // Cập nhật trò chơi tiếp tục
                            database.ref('games/' + currentGameId).update({
                                board: board,
                                currentTurn: nextTurn
                            });
                        }
                        
                        isMyTurn = false;
                    }
                }
            });
        }

        // Kiểm tra trạng thái trò chơi
        function checkGameStatus(board) {
            // Các trường hợp thắng
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Hàng ngang
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Hàng dọc
                [0, 4, 8], [2, 4, 6]             // Đường chéo
            ];
            
            // Kiểm tra thắng
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return { status: 'win', pattern };
                }
            }
            
            // Kiểm tra hòa
            if (!board.includes('')) {
                return { status: 'draw' };
            }
            
            // Trò chơi tiếp tục
            return { status: 'continue' };
        }
    </script>
</body>
</html>
