<!DOCTYPE html>
<html>
<head>
    <title>Audio Call P2P</title>
</head>
<body>
    <h1>Audio Call Demo (P2P)</h1>
    
    <!-- Controls -->
    <button onclick="startCall()">Start Call</button>
    <button onclick="endCall()">End Call</button>
    
    <!-- Remote Audio -->
    <audio id="remoteAudio" autoplay></audio>

    <script>
        let localStream;
        let peerConnection;

        // Cấu hình WebRTC (dùng public STUN server của Google)
        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // Khởi tạo call
        async function startCall() {
            try {
                // Lấy microphone
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Tạo PeerConnection
                peerConnection = new RTCPeerConnection(configuration);

                // Thêm stream local vào peerConnection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Nhận stream từ remote
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteAudio').srcObject = event.streams[0];
                };

                // Xử lý ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Gửi candidate đến remote peer (qua signaling server, clipboard, etc.)
                        // Trong ví dụ này, in ra console để copy/paste thủ công
                        console.log('ICE Candidate:', JSON.stringify(event.candidate));
                    }
                };

                // Tạo offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                console.log('Offer:', JSON.stringify(offer));

            } catch (error) {
                console.error('Error starting call:', error);
            }
        }

        // Kết thúc call
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        }

        // Giả lập signaling: Dán offer/answer/candidate từ remote vào đây
        // (Trong thực tế, cần dùng signaling server hoặc copy/paste thủ công)
        async function handleRemoteSignal(signal) {
            try {
                const message = JSON.parse(signal);
                
                if (message.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    console.log('Answer:', JSON.stringify(answer));
                
                } else if (answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                
                } else if (message.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            } catch (error) {
                console.error('Error handling signal:', error);
            }
        }
    </script>
</body>
</html>
