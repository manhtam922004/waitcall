<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Voice Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }

        button:disabled {
            background-color: #cccccc;
        }

        #status {
            font-size: 20px;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            button {
                width: 100%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Random Voice Chat</h1>
        <div id="status">Click 'Start' to begin</div>
        <button id="startButton" onclick="startConnection()">Start</button>
        <button id="endButton" onclick="endCall()" disabled>End Call</button>
        <label>
            <input type="checkbox" id="autoConnect" checked> Auto connect to new peer
        </label>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let currentConnection = null;
        let localStream = null;
        const audioElements = {};

        async function startConnection() {
            document.getElementById('startButton').disabled = true;
            document.getElementById('endButton').disabled = false;
            document.getElementById('status').textContent = 'Connecting...';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initializePeer();
            } catch (error) {
                console.error('Error accessing microphone:', error);
                document.getElementById('status').textContent = 'Microphone access required!';
            }
        }

        function initializePeer() {
            peer = new Peer({
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                pingInterval: 5000
            });

            peer.on('open', id => {
                document.getElementById('status').textContent = 'Searching for someone...';
                connectToNewPeer();
            });

            peer.on('connection', connection => {
                connection.on('open', () => {
                    if (!currentConnection) {
                        currentConnection = connection;
                        setupConnection(connection);
                    }
                });
            });

            peer.on('error', error => {
                console.error('PeerJS error:', error);
                document.getElementById('status').textContent = 'Connection error!';
            });
        }

        function connectToNewPeer() {
            peer.listAllPeers(peers => {
                const availablePeers = peers.filter(peerId => 
                    peerId !== peer.id && 
                    !currentConnection &&
                    peerId.startsWith('peerjs')
                );

                if (availablePeers.length > 0) {
                    const randomPeer = availablePeers[Math.floor(Math.random() * availablePeers.length)];
                    const connection = peer.connect(randomPeer);
                    setupConnection(connection);
                    currentConnection = connection;
                } else {
                    setTimeout(connectToNewPeer, 2000);
                }
            });
        }

        function setupConnection(connection) {
            connection.on('open', () => {
                document.getElementById('status').textContent = 'Connected!';
                startVoiceChat(connection);
            });

            connection.on('close', () => {
                endCall();
                if (document.getElementById('autoConnect').checked) {
                    connectToNewPeer();
                }
            });
        }

        async function startVoiceChat(connection) {
            const call = peer.call(connection.peer, localStream);
            
            call.on('stream', remoteStream => {
                if (!audioElements[connection.peer]) {
                    const audio = document.createElement('audio');
                    audio.srcObject = remoteStream;
                    audio.play();
                    audioElements[connection.peer] = audio;
                }
            });

            call.on('close', endCall);
        }

        function endCall() {
            if (currentConnection) {
                currentConnection.close();
                currentConnection = null;
            }
            document.getElementById('status').textContent = 'Call ended';
            document.getElementById('startButton').disabled = false;
            document.getElementById('endButton').disabled = true;
            
            if (document.getElementById('autoConnect').checked) {
                startConnection();
            }
        }

        // Check for media device support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('status').textContent = 'Audio is not supported in this browser';
            document.getElementById('startButton').disabled = true;
        }
    </script>
</body>
</html>
