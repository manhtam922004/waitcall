<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaitCall - Trò chuyện ngẫu nhiên</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* === Toàn bộ CSS gốc giữ nguyên === */
        * { margin:0; padding:0; box-sizing:border-box; font-family:Arial, sans-serif; }
        body { background:#f5f5f5; color:#333; line-height:1.6; }
        .container { max-width:1100px; margin:0 auto; padding:20px; }
        header { text-align:center; margin-bottom:30px; padding:20px 0; }
        h1 { color:#2c3e50; font-size:2.5em; margin-bottom:8px; }
        .mode-selection { display:flex; justify-content:center; gap:15px; margin-bottom:20px; }
        .mode-btn { padding:12px 25px; border:none; border-radius:25px; background:#ecf0f1; 
                    cursor:pointer; transition:all 0.3s; font-weight:bold; color:#34495e; }
        .mode-btn.active { background:#3498db; color:white; transform:translateY(-2px); 
                          box-shadow:0 5px 15px rgba(52,152,219,0.3); }
        .status { text-align:center; margin:20px 0; padding:15px; border-radius:10px; 
                 background:#ecf0f1; font-weight:bold; font-size:0.95em; }
        .status.waiting { background:#f39c12; color:white; animation:pulse 1.5s infinite; }
        .status.connected { background:#2ecc71; color:white; }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.7; } 100% { opacity:1; } }
        .action-buttons { display:flex; justify-content:center; gap:20px; margin:20px 0; }
        .primary-btn { padding:12px 25px; border:none; border-radius:5px; font-size:16px; 
                      font-weight:bold; cursor:pointer; transition:all 0.3s; }
        .wait-btn { background:#3498db; color:white; }
        .end-btn { background:#e74c3c; color:white; }
        .hidden { display:none !important; }
        .content-container { display:flex; height:calc(100vh - 300px); min-height:450px; gap:20px; }
        .video-container { flex:3; display:flex; flex-direction:column; gap:20px; }
        .video-wrapper { flex:1; position:relative; background:#000; border-radius:8px; overflow:hidden; }
        .video-element { width:100%; height:100%; object-fit:cover; }
        .local-video-wrapper { position:absolute; width:150px; height:150px; bottom:10px; right:10px; 
                              border-radius:8px; overflow:hidden; border:2px solid white; z-index:10; }
        .controls { display:flex; justify-content:center; gap:15px; margin-top:10px; }
        .control-btn { width:40px; height:40px; border-radius:50%; border:none; 
                      background:rgba(0,0,0,0.2); color:white; cursor:pointer; 
                      display:flex; align-items:center; justify-content:center; }
        .chat-box { flex:1; display:flex; flex-direction:column; border:1px solid #ddd; 
                   border-radius:8px; overflow:hidden; background:white; }
        .chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
        .message { padding:10px; border-radius:8px; max-width:70%; word-break:break-word; }
        .message.received { background:#ecf0f1; align-self:flex-start; }
        .message.sent { background:#3498db; color:white; align-self:flex-end; }
        .message-input { display:flex; padding:10px; border-top:1px solid #ddd; }
        .message-input input { flex:1; padding:10px; border:1px solid #ddd; border-radius:20px; outline:none; }
        .message-input button { margin-left:10px; padding:10px 15px; border:none; border-radius:20px; 
                               background:#3498db; color:white; cursor:pointer; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WaitCall</h1>
            <p>Trò chuyện ngẫu nhiên với người lạ</p>
        </header>
        
        <div class="mode-selection">
            <button class="mode-btn active" data-mode="video">Video Call</button>
            <button class="mode-btn" data-mode="audio">Audio Call</button>
            <button class="mode-btn" data-mode="chat">Chat Only</button>
        </div>
        
        <div class="status" id="status-message">
            Chọn chế độ và nhấn "Bắt đầu tìm kiếm" để kết nối
        </div>

        <div class="action-buttons">
            <button class="primary-btn wait-btn" id="start-btn">Bắt đầu tìm kiếm</button>
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="auto-reconnect-switch">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">Tự động tìm</span>
            </div>
            <button class="primary-btn end-btn hidden" id="end-btn">Kết thúc</button>
        </div>

        <div class="content-container">
            <div class="video-container" id="video-container">
                <div class="video-wrapper">
                    <video class="video-element" id="remote-video" autoplay playsinline></video>
                    <div class="local-video-wrapper">
                        <video class="video-element" id="local-video" autoplay playsinline muted></video>
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn" id="toggle-video"><i class="fas fa-video"></i></button>
                    <button class="control-btn" id="toggle-audio"><i class="fas fa-microphone"></i></button>
                </div>
            </div>

            <div class="chat-box hidden" id="chat-container">
                <div class="chat-messages" id="chat-messages"></div>
                <div class="message-input">
                    <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
                    <button id="send-message"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CẤU HÌNH NÂNG CAO ====================
        const firebaseConfig = {
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.appspot.com",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== BIẾN VÀ HẰNG SỐ ====================
        let userId = generateUserId();
        let currentMode = 'video';
        let isWaiting = false;
        let isConnected = false;
        let autoReconnect = false;
        let peerConnection = null;
        let dataChannel = null;
        let currentRoomId = null;
        let localStream = null;
        let waitingRef = null;

        const rtcConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" },
                { 
                    urls: "turn:your-turn-server.com",
                    username: "username",
                    credential: "password"
                }
            ]
        };

        // ==================== CORE FUNCTIONS ====================
        async function initMediaStream(mode) {
            try {
                const constraints = {
                    audio: true,
                    video: mode === 'video' ? {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    } : false
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('local-video').srcObject = localStream;
                return localStream;
            } catch (error) {
                console.error("Lỗi truy cập thiết bị:", error);
                alert("Vui lòng cho phép truy cập camera/microphone!");
                handleDisconnect();
                return null;
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);

            // Thêm track local
            localStream?.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Xử lý ICE Candidate
            peerConnection.onicecandidate = ({ candidate }) => {
                if (candidate && currentRoomId) {
                    database.ref(`rooms/${currentRoomId}/candidates/${userId}`).push(candidate.toJSON());
                }
            };

            // Xử lý remote track
            peerConnection.ontrack = (event) => {
                const remoteVideo = document.getElementById('remote-video');
                if (event.track.kind === 'video') {
                    remoteVideo.srcObject = event.streams[0];
                }
                setupDataChannel();
            };
        }

        // ==================== IMPROVED CONNECTION LOGIC ====================
        async function startWaiting() {
            if (isWaiting || isConnected) return;

            try {
                isWaiting = true;
                updateStatusUI('waiting');
                
                if (currentMode !== 'chat') {
                    await initMediaStream(currentMode);
                }

                createPeerConnection();
                setupDataChannel();

                waitingRef = database.ref('waiting');
                const snapshot = await waitingRef.orderByChild('mode').equalTo(currentMode).once('value');
                const waitingUsers = snapshot.val() || {};

                if (Object.keys(waitingUsers).length > 0) {
                    const partnerId = Object.keys(waitingUsers)[0];
                    currentRoomId = `${partnerId}_${userId}`;
                    await createOffer(partnerId);
                    await waitingRef.child(partnerId).remove();
                } else {
                    await waitingRef.child(userId).set({
                        mode: currentMode,
                        timestamp: Date.now()
                    });
                    listenForPartner();
                }

            } catch (error) {
                console.error("Lỗi bắt đầu kết nối:", error);
                handleDisconnect();
            }
        }

        async function createOffer(partnerId) {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await database.ref(`rooms/${currentRoomId}`).set({
                offer: offer,
                from: userId,
                to: partnerId,
                mode: currentMode
            });

            // Lắng nghe answer
            database.ref(`rooms/${currentRoomId}/answer`).on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            // Lắng nghe ICE candidates
            database.ref(`rooms/${currentRoomId}/candidates/${partnerId}`).on('child_added', async (snapshot) => {
                try {
                    const candidate = new RTCIceCandidate(snapshot.val());
                    await peerConnection.addIceCandidate(candidate);
                } catch (error) {
                    console.error("Lỗi thêm ICE candidate:", error);
                }
            });
        }

        function listenForPartner() {
            waitingRef.on('child_added', async (snapshot) => {
                if (snapshot.key === userId) return;

                currentRoomId = `${snapshot.key}_${userId}`;
                const roomRef = database.ref(`rooms/${currentRoomId}`);

                roomRef.once('value', async (snapshot) => {
                    const data = snapshot.val();
                    if (data?.offer) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        await roomRef.update({ answer: answer });
                        
                        database.ref(`rooms/${currentRoomId}/candidates/${data.from}`).on('child_added', async (candidateSnapshot) => {
                            try {
                                const candidate = new RTCIceCandidate(candidateSnapshot.val());
                                await peerConnection.addIceCandidate(candidate);
                            } catch (error) {
                                console.error("Lỗi thêm ICE candidate:", error);
                            }
                        });
                    }
                });
            });
        }

        // ==================== IMPROVED DATA CHANNEL ====================
        function setupDataChannel() {
            if (!dataChannel) {
                dataChannel = peerConnection.createDataChannel('chat');
                
                dataChannel.onopen = () => {
                    isConnected = true;
                    updateStatusUI('connected');
                    document.getElementById('chat-container').classList.remove('hidden');
                    document.getElementById('end-btn').classList.remove('hidden');
                };

                dataChannel.onmessage = (event) => {
                    displayMessage(event.data, false);
                };

                dataChannel.onclose = () => {
                    handleDisconnect();
                };
            }
        }

        // ==================== IMPROVED CLEANUP ====================
        async function handleDisconnect() {
            try {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (currentRoomId) {
                    await database.ref(`rooms/${currentRoomId}`).remove();
                }
                if (waitingRef) {
                    await waitingRef.child(userId).remove();
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                isConnected = false;
                isWaiting = false;
                dataChannel = null;
                currentRoomId = null;
                
                updateStatusUI('idle');
                document.getElementById('end-btn').classList.add('hidden');
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('chat-container').classList.add('hidden');

                if (autoReconnect) setTimeout(startWaiting, 1000);
                
            } catch (error) {
                console.error("Lỗi khi ngắt kết nối:", error);
            }
        }

        async function createOffer(partnerId) {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Lưu offer vào Firebase
            await database.ref(`rooms/${currentRoomId}`).set({
                offer: offer,
                from: userId,
                to: partnerId,
                mode: currentMode
            });

            // Lắng nghe answer
            database.ref(`rooms/${currentRoomId}/answer`).on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            // Lắng nghe ICE candidates
            database.ref(`rooms/${currentRoomId}/candidates/${partnerId}`).on('child_added', async (snapshot) => {
                const candidate = new RTCIceCandidate(snapshot.val());
                await peerConnection.addIceCandidate(candidate);
            });
        }

        function listenForPartner() {
            database.ref('waiting').on('child_added', async (snapshot) => {
                if (snapshot.key === userId) return;

                currentRoomId = `${snapshot.key}_${userId}`;
                const roomRef = database.ref(`rooms/${currentRoomId}`);

                // Xử lý offer
                roomRef.once('value', async (snapshot) => {
                    const data = snapshot.val();
                    if (data?.offer) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        
                        // Tạo answer
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        // Gửi answer
                        await roomRef.update({ answer: answer });
                        
                        // Lắng nghe ICE candidates
                        database.ref(`rooms/${currentRoomId}/candidates/${data.from}`).on('child_added', async (candidateSnapshot) => {
                            const candidate = new RTCIceCandidate(candidateSnapshot.val());
                            await peerConnection.addIceCandidate(candidate);
                        });
                    }
                });
            });
        }

        // ==================== DATA CHANNEL ====================
        function setupDataChannel() {
            dataChannel = peerConnection.createDataChannel('chat');
            
            dataChannel.onopen = () => {
                isConnected = true;
                updateStatusUI('connected');
                document.getElementById('end-btn').classList.remove('hidden');
            };

            dataChannel.onmessage = (event) => {
                displayMessage(event.data, false);
            };

            dataChannel.onclose = () => {
                handleDisconnect();
            };
        }

        // ==================== CHAT HANDLING ====================
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message && dataChannel?.readyState === 'open') {
                dataChannel.send(message);
                displayMessage(message, true);
                input.value = '';
            }
        }

        function displayMessage(text, isSent) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageElem = document.createElement('div');
            messageElem.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElem.textContent = text;
            messagesDiv.appendChild(messageElem);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ==================== EVENT HANDLERS ====================
        document.getElementById('start-btn').addEventListener('click', startWaiting);
        document.getElementById('end-btn').addEventListener('click', handleDisconnect);
        document.getElementById('send-message').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.mode-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            });
        });

        // ==================== CLEANUP ====================
        async function handleDisconnect() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (currentRoomId) {
                await database.ref(`rooms/${currentRoomId}`).remove();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            isConnected = false;
            isWaiting = false;
            updateStatusUI('idle');
            document.getElementById('end-btn').classList.add('hidden');
            document.getElementById('remote-video').srcObject = null;
            
            if (autoReconnect) startWaiting();
        }

        window.addEventListener('beforeunload', handleDisconnect);
    </script>
</body>
</html>
