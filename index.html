<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Random Audio Call</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    .header {
      text-align: center;
      padding: 10px;
      background-color: #007bff;
      color: white;
    }
    .main-screen, .call-screen {
      flex-grow: 1;
      text-align: center;
      padding: 20px;
    }
    .btn {
      margin: 5px;
    }
    #remoteAudio {
      display: none; /* Hidden but plays audio */
    }
    .chat-window {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background-color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Random Audio Call</h1>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label for="genderSelect">Your Gender:</label>
            <select id="genderSelect" class="form-select">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
            <label for="interestSelect" class="mt-2">Interested In:</label>
            <select id="interestSelect" class="form-select">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="both">Both</option>
              <option value="other">Other</option>
            </select>
            <div class="form-check mt-2">
              <input type="checkbox" class="form-check-input" id="autoReconnect">
              <label class="form-check-label" for="autoReconnect">Auto Reconnect</label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chat</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="chatMessages" class="chat-window"></div>
            <input type="text" id="chatInput" class="form-control" placeholder="Type a message">
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="sendChat()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="main-screen">
      <p>Online Users: <span id="onlineCount">0</span></p>
      <button class="btn btn-primary" id="startButton">Start Matching</button>
      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">Settings</button>
    </div>

    <!-- Call Screen -->
    <div id="callScreen" class="call-screen" style="display: none;">
      <p>Connected to: <span id="partnerInfo"></span></p>
      <audio id="remoteAudio" autoplay></audio>
      <button class="btn btn-warning" id="muteButton" onclick="toggleMute()">Mute</button>
      <button class="btn btn-danger" id="endButton" onclick="endCall()" disabled>End Call</button>
      <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#chatModal">Chat</button>
    </div>
  </div>

  <script>
    // Firebase Configuration (replace with your own config)
    const firebaseConfig = {

	  apiKey: "AIzaSyAl91PG5SUQlqwtoTyv3AF-KF79pZBDxOY",
	  authDomain: "waitcall-95d60.firebaseapp.com",
	  databaseURL: "https://waitcall-95d60-default-rtdb.asia-southeast1.firebasedatabase.app/",
	  projectId: "waitcall-95d60",
	  storageBucket: "waitcall-95d60.firebasestorage.app",
	  messagingSenderId: "133568729774",
	  appId: "1:133568729774:web:32162b66f5b021b7e7d33f",

    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // PeerJS Configuration
    const peer = new Peer({
      host: '0.peerjs.com',
      port: 443,
      path: '/',
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:relay1.expressturn.com:3478', username: 'efPIUBIBH3U4IK8NOJ', credential: 'gYdRWK0C6KRv9uX1' },
          { urls: 'turn:relay1.expressturn.com:3478', username: 'efZIMBC840LYVN1PCG', credential: 'd0FoTsKX6aWJjmj5' },
          { urls: 'turn:relay1.expressturn.com:3478', username: 'efX51BHDW5FDLPOTY4', credential: 'uyFPLUJfk9cQ5WsA' },
          { urls: 'turn:relay1.expressturn.com:3478', username: 'efUZ3N3V769535YL81', credential: 'HUhaUwQvzY0s0ILv' }
        ]
      }
    });

    let localStream, call, dataConnection, country = 'Unknown', partnerGender, partnerCountry;

    // Get user's country
    fetch('https://ipapi.co/json/')
      .then(response => response.json())
      .then(data => country = data.country_name || 'Unknown')
      .catch(() => country = 'Unknown');

    // Check and load settings
    window.onload = function() {
      if (!localStorage.getItem('gender') || !localStorage.getItem('interest')) {
        new bootstrap.Modal(document.getElementById('settingsModal')).show();
      } else {
        document.getElementById('genderSelect').value = localStorage.getItem('gender');
        document.getElementById('interestSelect').value = localStorage.getItem('interest');
        document.getElementById('autoReconnect').checked = localStorage.getItem('autoReconnect') === 'true';
      }
      updateOnlineCount();
    };

    // Save settings to local storage
    function saveSettings() {
      const gender = document.getElementById('genderSelect').value;
      const interest = document.getElementById('interestSelect').value;
      const autoReconnect = document.getElementById('autoReconnect').checked;
      localStorage.setItem('gender', gender);
      localStorage.setItem('interest', interest);
      localStorage.setItem('autoReconnect', autoReconnect);
      bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    }

    // Update online users count
    function updateOnlineCount() {
      database.ref('available_users').on('value', snapshot => {
        const count = snapshot.val() ? Object.keys(snapshot.val()).length : 0;
        document.getElementById('onlineCount').textContent = count;
      });
    }

    // Start matching
    document.getElementById('startButton').addEventListener('click', function() {
      document.getElementById('startButton').disabled = true;
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          localStream = stream;
          const userId = peer.id;
          const gender = localStorage.getItem('gender');
          const interest = localStorage.getItem('interest');
          database.ref('available_users/' + userId).set({
            gender: gender,
            interest: interest,
            country: country
          });
          findMatch();
        })
        .catch(err => {
          alert('Microphone access is required!');
          document.getElementById('startButton').disabled = false;
        });
    });

    // Find a compatible match
    function findMatch() {
      database.ref('available_users').once('value', snapshot => {
        const users = snapshot.val();
        if (!users) {
          setTimeout(findMatch, 5000);
          return;
        }
        const myGender = localStorage.getItem('gender');
        const myInterest = localStorage.getItem('interest');
        const compatibleUsers = Object.keys(users).filter(key => key !== peer.id && isCompatible(users[key]));
        if (compatibleUsers.length > 0) {
          const partnerId = compatibleUsers[Math.floor(Math.random() * compatibleUsers.length)];
          partnerGender = users[partnerId].gender;
          partnerCountry = users[partnerId].country;
          database.ref('available_users/' + peer.id).remove();
          database.ref('available_users/' + partnerId).remove();
          initiateCall(partnerId);
        } else {
          setTimeout(findMatch, 5000);
        }
      });
    }

    // Compatibility check
    function isCompatible(user) {
      const myGender = localStorage.getItem('gender');
      const myInterest = localStorage.getItem('interest');
      if (myInterest === 'both') return user.interest === 'both' || user.interest === myGender || user.interest === 'other';
      if (myInterest === 'other') return user.interest === 'other' || user.gender === 'other';
      return user.gender === myInterest && (user.interest === myGender || user.interest === 'both');
    }

    // Initiate audio call and data connection
    function initiateCall(partnerId) {
      document.getElementById('partnerInfo').textContent = `${partnerGender} from ${partnerCountry}`;
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('callScreen').style.display = 'block';
      call = peer.call(partnerId, localStream);
      call.on('stream', stream => {
        document.getElementById('remoteAudio').srcObject = stream;
      });
      call.on('close', handleCallEnd);
      dataConnection = peer.connect(partnerId);
      dataConnection.on('open', () => {
        dataConnection.on('data', data => appendChatMessage('Partner', data));
      });
      setTimeout(() => document.getElementById('endButton').disabled = false, 10000);
    }

    // Handle incoming calls
    peer.on('call', incomingCall => {
      incomingCall.answer(localStream);
      call = incomingCall;
      call.on('stream', stream => {
        document.getElementById('remoteAudio').srcObject = stream;
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('callScreen').style.display = 'block';
      });
      call.on('close', handleCallEnd);
      setTimeout(() => document.getElementById('endButton').disabled = false, 10000);
    });

    peer.on('connection', conn => {
      dataConnection = conn;
      dataConnection.on('data', data => appendChatMessage('Partner', data));
    });

    // Toggle mute
    function toggleMute() {
      const enabled = localStream.getAudioTracks()[0].enabled;
      localStream.getAudioTracks()[0].enabled = !enabled;
      document.getElementById('muteButton').textContent = enabled ? 'Unmute' : 'Mute';
    }

    // End call
    function endCall() {
      if (call) call.close();
      if (dataConnection) dataConnection.close();
      document.getElementById('callScreen').style.display = 'none';
      document.getElementById('mainScreen').style.display = 'block';
      document.getElementById('startButton').disabled = false;
      document.getElementById('chatMessages').innerHTML = '';
      if (localStorage.getItem('autoReconnect') === 'true') {
        document.getElementById('startButton').click();
      }
    }

    // Handle call end
    function handleCallEnd() {
      endCall();
    }

    // Send chat message
    function sendChat() {
      const message = document.getElementById('chatInput').value;
      if (message && dataConnection) {
        dataConnection.send(message);
        appendChatMessage('You', message);
        document.getElementById('chatInput').value = '';
      }
    }

    // Append chat message
    function appendChatMessage(sender, message) {
      const chat = document.getElementById('chatMessages');
      chat.innerHTML += `<p><strong>${sender}:</strong> ${message}</p>`;
      chat.scrollTop = chat.scrollHeight;
    }

    // Clean up on disconnect
    window.onbeforeunload = () => database.ref('available_users/' + peer.id).remove();
  </script>
</body>
</html>
