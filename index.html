<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Call</title>
    <style>
        #localVideo, #remoteVideo {
            width: 300px;
            height: 200px;
            border: 1px solid black;
        }
    </style>
</head>
<body>

    <h1>WebRTC Call</h1>

    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <button id="callButton">Call</button>
    <button id="hangupButton">Hang Up</button>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvxl_a9NurzYLnAfuYM1sHnfuCc03gjoA",
            authDomain: "waitcall-87f5e.firebaseapp.com",
            databaseURL: "https://waitcall-87f5e-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "waitcall-87f5e",
            storageBucket: "waitcall-87f5e.firebasestorage.app",
            messagingSenderId: "535766267900",
            appId: "1:535766267900:web:572b04459493c157bd6479"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');

        let peerConnection;
        let localStream;
        let remoteStream;
        let roomId;

        // Function to create or join a room
        async function createOrJoinRoom() {
            // Basic authentication (you'll likely want to improve this)
            await auth.signInAnonymously();

            // Generate a unique room ID (you can use a library for this)
            roomId = 'test-room'; // Replace with dynamic room ID generation

            const roomRef = db.ref(`rooms/${roomId}`);

            // Check if the room exists
            const roomSnapshot = await roomRef.once('value');

            if (!roomSnapshot.exists()) {
                // Create the room
                await roomRef.set({ creator: auth.currentUser.uid });
                console.log('Room created.');
            } else {
                console.log('Room joined.');
            }

            return roomRef;
        }


        async function startCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                const roomRef = await createOrJoinRoom();

                peerConnection = new RTCPeerConnection(null);

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        roomRef.child('candidates').push(event.candidate);
                    }
                };

                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                };

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // Offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await roomRef.child('offer').set(offer);

                // Listen for answer
                roomRef.child('answer').on('value', async snapshot => {
                    if (snapshot.val()) {
                        await peerConnection.setRemoteDescription(snapshot.val());
                    }
                });

                // Listen for remote candidates
                roomRef.child('candidates').on('child_added', async snapshot => {
                    if (snapshot.val()) {
                        try {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                        } catch (error) {
                            console.error("Error adding ICE candidate:", error);
                        }
                    }
                });

            } catch (error) {
                console.error("Error starting call:", error);
            }
        }

        async function hangup() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            remoteVideo.srcObject = null;

            // Clean up Firebase room (optional)
            if (roomId) {
                const roomRef = db.ref(`rooms/${roomId}`);
                roomRef.remove();
            }
        }

        callButton.addEventListener('click', startCall);
        hangupButton.addEventListener('click', hangup);

    </script>

</body>
</html>
